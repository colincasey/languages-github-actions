name: Prepare Buildpack Release
description: "Prepares a buildpack release by bumping the fixed version and updating changelogs"

inputs:
  bump:
    description: Which coordinate should be incremented? (major, minor, patch)
    required: true

outputs:
  from_version:
    description: The previous version
    value: ${{ steps.prepare.outputs.from_version }}
  to_version:
    description: The next version
    value: ${{ steps.prepare.outputs.to_version }}
  unreleased_changes:
    description: Markdown content listing the changes about to be released
    value: ${{ steps.prepare.outputs.unreleased_changes }}

runs:
  using: "composite"
  steps:
    - name: Checkout Repo
      uses: actions/checkout@v3
    - id: install-rust-toolchain
      name: Install Rust Toolchain
      uses: actions-rs/toolchain@v1
      with:
        toolchain: stable
        profile: minimal
    - name: Rust cache
      uses: Swatinem/rust-cache@v2
    - id: prepare
      name: Prepare Release
      run: |
        cd ${{ github.action_path }}
        cargo run --bin prepare_release -- --bump ${{ inputs.bump }} ${{ github.workspace }}
        cat $GITHUB_OUTPUT
      shell: bash
    - name: Create Pull Request
      uses: peter-evans/create-pull-request@v5
      with:
        title: Prepare release v${{ steps.prepare.outputs.to_version }}
        commit-message: Prepare release v${{ steps.prepare.outputs.to_version }}
        branch: release/v${{ steps.prepare.outputs.to_version }}
        body: ${{ steps.prepare.outputs.unreleased_changes }}
        labels: "automation"